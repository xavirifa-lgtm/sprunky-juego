<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#333333">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sprunki">

    <link rel="manifest" href="manifest.json">

    <title>Sprunki Pictionary</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS GENERALES --- */
        body {
            margin: 0; padding: 0;
            overflow: hidden; background-color: #333;
            touch-action: none; 
            font-family: 'Bungee', 'Impact', sans-serif;
            -webkit-user-select: none; user-select: none;
            /* Previene el rebote el√°stico en iOS */
            overscroll-behavior: none;
        }

        /* --- PANTALLAS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 5000; transition: opacity 0.5s;
        }

        /* 1. SELECCI√ìN */
        #setup-screen { background: rgba(0,0,0,0.95); color: white; text-align: center; }
        #char-grid { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin: 30px 0; }

        .char-select-btn {
            width: 13vmin; height: 13vmin;
            background-color: #555; background-size: cover; background-position: center;
            border-radius: 50%; border: 4px solid rgba(255,255,255,0.3);
            cursor: pointer; opacity: 0.6; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; color: white;
        }
        .char-select-btn.selected { border-color: #2ed573; box-shadow: 0 0 20px #2ed573; opacity: 1; transform: scale(1.1); }

        /* 2. NOMBRES */
        #name-screen { background: rgba(0,0,0,0.95); color: white; display: none; }
        #name-inputs-container {
            display: flex; flex-direction: column; gap: 15px; 
            max-height: 55vh; overflow-y: auto; padding: 10px; width: 90%; max-width: 600px;
            touch-action: pan-y; 
        }
        .player-input-row {
            display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.1);
            padding: 10px 20px; border-radius: 50px; justify-content: center;
        }
        .mini-avatar {
            width: 60px; height: 60px; border-radius: 50%; background-size: cover; 
            background-color: #777; border: 2px solid white; flex-shrink: 0;
        }
        .name-input {
            background: transparent; border: none; border-bottom: 2px solid white;
            color: white; font-family: sans-serif; font-weight: bold; font-size: 24px;
            width: 100%; text-align: left; outline: none;
            touch-action: auto !important; user-select: text !important;
        }
        .name-input::placeholder { color: rgba(255,255,255,0.5); font-size: 18px; }

        .action-btn {
            padding: 20px 50px; font-size: 28px; font-family: inherit; margin-top: 20px;
            background: #ff4757; color: white; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 6px 0 #b33939; opacity: 0.5; pointer-events: none;
            transition: transform 0.1s;
        }
        .action-btn.active { opacity: 1; pointer-events: auto; }
        .action-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #b33939; }

        /* 3. JUEGO */
        #game-container {
            position: relative; width: 100vw; 
            height: 100vh; height: 100dvh; 
            background-color: #00d2ff; 
            background-image: url('fondo.webp'); background-size: cover; background-position: center;
            display: none;
        }

        .step {
            position: absolute; width: 12vmin; height: 12vmin;
            border-radius: 50%; border: 4px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 5vmin; text-shadow: 2px 2px 2px rgba(0,0,0,0.5);
            transform: translate(-50%, -50%); z-index: 1;
        }
        .bg-red { background: #ff4757; } .bg-orange { background: #ffa502; }
        .bg-yellow { background: #eccc68; color: #333; } .bg-green { background: #2ed573; }
        .bg-blue { background: #1e90ff; } .bg-purple { background: #5352ed; }

        .step.start { width: 14vmin; height: 14vmin; background: #2f3542; z-index: 2; font-size: 3vmin; }
        .step.finish {
            width: 20vmin; height: 20vmin;
            background: conic-gradient(red, orange, yellow, lime, cyan, blue, magenta, red);
            animation: spin 4s linear infinite; border: 6px solid white; z-index: 1;
        }
        .step.finish::after { content: 'FIN'; font-size: 5vmin; }
        @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        .token {
            position: absolute; width: 13vmin; height: 13vmin;
            border-radius: 50%; border: 3px solid white; background-color: white;
            background-size: cover; background-position: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); cursor: grab; z-index: 10;
            transform: translate(-50%, -50%); opacity: 0.6; transition: transform 0.1s;
        }
        .token:active { cursor: grabbing; opacity: 1; transform: translate(-50%, -50%) scale(1.2); z-index: 100; }

        /* VICTORIA & DIPLOMA */
        #victory-screen { background: rgba(0,0,0,0.8); display: none; z-index: 6000; text-align: center; }
        .win-title { font-size: 8vmin; color: #ffeb3b; text-shadow: 0 0 20px #ff9800; margin-bottom: 20px; animation: pop 0.5s ease-out; }
        .winner-name { font-size: 10vmin; color: white; text-transform: uppercase; margin-bottom: 40px; }
        
        #diploma-screen { background: rgba(0,0,0,0.9); display: none; z-index: 7000; }
        .diploma-paper {
            background: #fffbf0; width: 85vw; padding: 40px;
            border: 15px solid #d4af37; border-radius: 10px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
            text-align: center; color: #333; position: relative;
        }
        .diploma-title { font-size: 5vmin; color: #c0392b; margin-bottom: 20px; }
        .diploma-text { font-family: sans-serif; font-size: 3vmin; margin: 10px 0; }
        .diploma-winner { font-size: 8vmin; color: #2c3e50; text-decoration: underline; margin: 20px 0; text-transform: uppercase; font-weight: bold;}
        .diploma-sign { font-family: sans-serif; margin-top: 40px; font-weight: bold; font-size: 2.5vmin;}
        
        #confetti { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 6500; }
        @keyframes pop { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="setup-screen" class="screen">
        <h1 style="font-size: 5vmin;">ELIGE TU PERSONAJE</h1>
        <div id="char-grid"></div>
        <button id="next-btn" class="action-btn">SIGUIENTE</button>
    </div>

    <div id="name-screen" class="screen">
        <h1 style="font-size: 5vmin; margin-bottom: 20px;">¬øC√ìMO OS LLAM√ÅIS?</h1>
        <div id="name-inputs-container"></div>
        <button id="start-game-btn" class="action-btn active">¬°A JUGAR!</button>
    </div>

    <div id="game-container"></div>

    <div id="victory-screen" class="screen">
        <canvas id="confetti"></canvas>
        <div class="win-title">¬°FELICIDADES!</div>
        <div class="win-title">HA GANADO</div>
        <div class="winner-name" id="winner-display">NOMBRE</div>
    </div>

    <div id="diploma-screen" class="screen">
        <div class="diploma-paper">
            <h1 class="diploma-title">üèÜ DIPLOMA OFICIAL üèÜ</h1>
            <p class="diploma-text">La Gran Academia de Sprunkis otorga este reconocimiento a:</p>
            <h2 class="diploma-winner" id="diploma-name">NOMBRE</h2>
            <p class="diploma-text">Por ser una S√∫per Lectora y completar el tablero con √©xito.</p>
            <div class="diploma-sign">Firmado: El Rey Sprunki üëë</div>
            <button class="action-btn active" onclick="location.reload()" style="font-size: 20px; margin-top: 30px;">Volver a Jugar</button>
        </div>
    </div>

    <script>
        // --- SISTEMA DE SONIDO (WEB AUDIO API) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // Sonido de ficha ("Pop")
        function playMoveSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(400, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        // Sonido de VICTORIA (Fanfarria)
        function playWinSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            
            // Notas: Do, Mi, Sol, Do (agudo)
            const notes = [523.25, 659.25, 783.99, 1046.50]; 
            
            notes.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.value = freq;
                
                // Tiempo de cada nota
                const startTime = now + (i * 0.15);
                const duration = 0.3;
                
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.2, startTime + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
                
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(startTime);
                osc.stop(startTime + duration);
            });
        }

        const setupScreen = document.getElementById('setup-screen');
        const nameScreen = document.getElementById('name-screen');
        const gameContainer = document.getElementById('game-container');
        const victoryScreen = document.getElementById('victory-screen');
        const diplomaScreen = document.getElementById('diploma-screen');
        const charGrid = document.getElementById('char-grid');
        const nextBtn = document.getElementById('next-btn');
        const nameContainer = document.getElementById('name-inputs-container');
        const startBtn = document.getElementById('start-game-btn');

        const allImages = ['verde.png', 'rosa.png', 'amarillo.png', 'naranja.png', 'verdeclaro.png', 'rojo.png', 'azul.png'];
        let selectedPlayers = []; 

        allImages.forEach(img => {
            const btn = document.createElement('div');
            btn.className = 'char-select-btn';
            btn.style.backgroundImage = `url('${img}')`;
            btn.innerText = ""; 
            btn.onclick = () => {
                const idx = selectedPlayers.findIndex(p => p.img === img);
                if(idx > -1) {
                    selectedPlayers.splice(idx, 1);
                    btn.classList.remove('selected');
                } else {
                    selectedPlayers.push({ img: img, name: '' });
                    btn.classList.add('selected');
                }
                nextBtn.classList.toggle('active', selectedPlayers.length > 0);
            };
            charGrid.appendChild(btn);
        });

        nextBtn.onclick = () => {
            setupScreen.style.display = 'none';
            nameScreen.style.display = 'flex';
            nameContainer.innerHTML = '';
            
            selectedPlayers.forEach((player, index) => {
                const row = document.createElement('div');
                row.className = 'player-input-row';
                row.innerHTML = `
                    <div class="mini-avatar" style="background-image: url('${player.img}')"></div>
                    <input type="text" class="name-input" placeholder="Nombre..." oninput="updateName('${player.img}', this.value)" autocomplete="off">
                `;
                nameContainer.appendChild(row);
            });
        };

        window.updateName = (img, val) => {
            const player = selectedPlayers.find(p => p.img === img);
            if(player) player.name = val;
        };

        startBtn.onclick = () => {
            selectedPlayers.forEach((p, i) => {
                if(!p.name || p.name.trim() === "") p.name = `Jugador ${i+1}`;
            });
            nameScreen.style.display = 'none';
            gameContainer.style.display = 'block';
            createBoard();
            createTokens();
        };

        // --- CAMINO ---
        const pathPoints = [
            { x: 10, y: 75 }, 
            { x: 25, y: 65 }, 
            { x: 10, y: 45 }, 
            { x: 25, y: 35 },
            { x: 45, y: 25 }, 
            { x: 65, y: 20 }, 
            { x: 85, y: 35 }, 
            { x: 75, y: 50 },
            { x: 55, y: 55 }, 
            { x: 40, y: 65 }, 
            { x: 65, y: 70 }, 
            { x: 85, y: 60 },
            { x: 90, y: 15 } // META
        ];
        const colors = ['bg-red', 'bg-orange', 'bg-yellow', 'bg-green', 'bg-blue', 'bg-purple'];

        function createBoard() {
            pathPoints.forEach((point, index) => {
                const step = document.createElement('div');
                step.className = 'step';
                step.style.left = point.x + '%'; step.style.top = point.y + '%';
                step.dataset.index = index;

                if (index === 0) {
                    step.classList.add('start'); step.innerText = "INICIO";
                } else if (index === pathPoints.length - 1) {
                    step.classList.add('finish');
                } else {
                    step.classList.add(colors[(index - 1) % colors.length]);
                    step.innerText = index;
                }
                gameContainer.appendChild(step);
            });
        }

        function createTokens() {
            selectedPlayers.forEach((player, i) => {
                const token = document.createElement('div');
                token.className = 'token';
                token.style.backgroundImage = `url('${player.img}')`;
                token.dataset.playerName = player.name; 
                token.style.backgroundColor = 'white'; 
                
                const offsetX = (i % 3 - 1) * 3; 
                const offsetY = (Math.floor(i / 3)) * 3; 
                token.style.left = `calc(${pathPoints[0].x}% + ${offsetX}vmin)`;
                token.style.top = `calc(${pathPoints[0].y}% + 12vmin + ${offsetY}vmin)`; 

                gameContainer.appendChild(token);
                enableDrag(token);
            });
        }

        function enableDrag(element) {
            let isDragging = false;
            
            function onStart(e) { 
                isDragging = true; 
                element.style.zIndex = 1000; 
                if(e.type === 'touchstart') e.preventDefault(); 
                if (audioCtx.state === 'suspended') audioCtx.resume();
            }

            function onMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                let clientX = e.touches ? e.touches[0].clientX : e.clientX;
                let clientY = e.touches ? e.touches[0].clientY : e.clientY;
                element.style.left = clientX + 'px';
                element.style.top = clientY + 'px';
            }
            
            function onEnd(e) {
                if (!isDragging) return;
                isDragging = false;
                element.style.zIndex = 10;
                checkVictory(element); 
            }

            element.addEventListener('mousedown', onStart);
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onEnd);
            element.addEventListener('touchstart', onStart, {passive: false});
            document.addEventListener('touchmove', onMove, {passive: false});
            document.addEventListener('touchend', onEnd);
        }

        function checkVictory(token) {
            const rect = token.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            let targetStep = null; let minDistance = Infinity;

            document.querySelectorAll('.step').forEach(step => {
                const stepRect = step.getBoundingClientRect();
                const stepX = stepRect.left + stepRect.width / 2;
                const stepY = stepRect.top + stepRect.height / 2;
                const dist = Math.hypot(stepX - centerX, stepY - centerY);
                if (dist < minDistance) { minDistance = dist; targetStep = step; }
            });

            if (minDistance < 100 && targetStep) {
                token.style.left = targetStep.style.left;
                token.style.top = targetStep.style.top;
                
                // Verificar si es la meta para tocar fanfarria o sonido normal
                if (targetStep.classList.contains('finish')) {
                    playWinSound();
                    triggerWinSequence(token.dataset.playerName);
                } else {
                    playMoveSound();
                }
            }
        }

        function triggerWinSequence(name) {
            document.getElementById('winner-display').innerText = name;
            victoryScreen.style.display = 'flex';
            startConfetti();
            setTimeout(() => {
                victoryScreen.style.display = 'none';
                document.getElementById('diploma-name').innerText = name;
                diplomaScreen.style.display = 'flex';
                stopConfetti();
            }, 4000);
        }

        let confettiInterval;
        function startConfetti() {
            const canvas = document.getElementById('confetti');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            const particles = [];
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
            for(let i=0; i<300; i++) {
                particles.push({
                    x: Math.random() * canvas.width, y: Math.random() * canvas.height - canvas.height,
                    vx: Math.random() * 4 - 2, vy: Math.random() * 5 + 2,
                    color: colors[Math.floor(Math.random() * colors.length)]
                });
            }
            confettiInterval = setInterval(() => {
                ctx.clearRect(0,0,canvas.width, canvas.height);
                particles.forEach(p => {
                    p.x += p.vx; p.y += p.vy;
                    if(p.y > canvas.height) p.y = -10;
                    ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 8, 8);
                });
            }, 20);
        }
        function stopConfetti() { clearInterval(confettiInterval); }
    </script>
</body>
</html>